<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>4x4 數字推盤 (2048風格)</title>
    <style>
        :root {
            --bg-color: #faf8ef;
            --grid-bg-color: #bbada0;
            --tile-color: #cdc1b4; /* 預設/空白顏色 */
            --tile-text-color: #776e65;
            --tile-bg-active: #eee4da; /* 類似 2048 的 2 */
            --tile-bg-high: #f2b179;   /* 類似 2048 的 8/16 */
            --gap-size: 10px;
            --tile-size: 80px;
        }

        * {
            box-sizing: border-box;
            user-select: none; /* 防止手機長按選取文字 */
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Clear Sans", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--tile-text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        header {
            width: 100%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 40px;
            margin: 0;
            font-weight: bold;
            color: #776e65;
        }

        .info-box {
            display: flex;
            gap: 10px;
        }

        .score-container {
            background: #bbada0;
            padding: 5px 15px;
            border-radius: 5px;
            color: white;
            text-align: center;
            min-width: 80px;
        }

        .score-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #eee4da;
        }

        .score-value {
            font-size: 20px;
            font-weight: bold;
        }

        /* 遊戲主容器 */
        .game-container {
            position: relative;
            background-color: var(--grid-bg-color);
            border-radius: 6px;
            padding: var(--gap-size);
            width: 90vw; /* 手機版寬度 */
            height: 90vw; /* 手機版高度保持正方形 */
            max-width: 500px; /* 電腦版最大寬度 */
            max-height: 500px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: var(--gap-size);
            touch-action: none; /* 防止手機滑動頁面 */
        }

        /* 方塊樣式 */
        .tile {
            background-color: var(--tile-bg-active);
            border-radius: 3px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            font-weight: bold;
            color: var(--tile-text-color);
            cursor: pointer;
            transition: transform 0.1s ease-in-out, background-color 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* 空白格 */
        .tile.empty {
            background-color: rgba(238, 228, 218, 0.35);
            box-shadow: none;
            cursor: default;
        }

        /* 給數字一點顏色變化，讓畫面更像2048 */
        .tile[data-val="1"], .tile[data-val="2"], .tile[data-val="3"], .tile[data-val="4"] {
            background-color: #eee4da; color: #776e65; 
        }
        .tile[data-val="5"], .tile[data-val="6"], .tile[data-val="7"], .tile[data-val="8"] {
            background-color: #ede0c8; color: #776e65;
        }
        .tile[data-val="9"], .tile[data-val="10"], .tile[data-val="11"], .tile[data-val="12"] {
            background-color: #f2b179; color: #f9f6f2;
        }
        .tile[data-val="13"], .tile[data-val="14"], .tile[data-val="15"] {
            background-color: #f59563; color: #f9f6f2;
        }

        /* 按鈕區域 */
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 20px;
        }

        button {
            background-color: #8f7a66;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            outline: none;
        }

        button:active {
            background-color: #796654;
            transform: scale(0.98);
        }

        /* 勝利覆蓋層 */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(238, 228, 218, 0.73);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .overlay h2 {
            font-size: 60px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #776e65;
        }

        /* 針對小螢幕手機調整字體大小 */
        @media (max-width: 400px) {
            .tile { font-size: 24px; }
            h1 { font-size: 32px; }
        }
    </style>
</head>
<body>

    <header>
        <h1>15-Puzzle</h1>
        <div class="info-box">
            <div class="score-container">
                <div class="score-title">Moves</div>
                <div class="score-value" id="move-count">0</div>
            </div>
            <div class="score-container">
                <div class="score-title">Time</div>
                <div class="score-value" id="time-count">0</div>
            </div>
        </div>
    </header>

    <div class="game-container" id="grid">
        <!-- 方塊將由 JS 生成 -->
        <div class="overlay" id="overlay">
            <h2>You Win!</h2>
            <button onclick="initGame()">Play Again</button>
        </div>
    </div>

    <div class="controls">
        <button onclick="initGame()">New Game</button>
    </div>

    <script>
        const gridElement = document.getElementById('grid');
        const moveDisplay = document.getElementById('move-count');
        const timeDisplay = document.getElementById('time-count');
        const overlay = document.getElementById('overlay');

        let tiles = []; // 儲存目前的數字狀態 (0 代表空白)
        let emptyIndex = 15; // 空白格的位置 (0-15)
        let moves = 0;
        let timer = 0;
        let timerInterval = null;
        let isGameActive = false;

        // 初始化遊戲
        function initGame() {
            // 停止舊計時器
            if (timerInterval) clearInterval(timerInterval);
            
            // 重置數據
            moves = 0;
            timer = 0;
            isGameActive = true;
            moveDisplay.innerText = moves;
            timeDisplay.innerText = timer;
            overlay.classList.remove('show');

            // 建立已完成的陣列 [1, 2, ..., 15, 0]
            tiles = Array.from({length: 16}, (_, i) => (i + 1) % 16);
            emptyIndex = 15;

            // 洗牌（確保有解）：從完成狀態開始，隨機移動空白格
            shuffleTiles(300); 

            render();
            startTimer();
        }

        // 渲染畫面
        function render() {
            // 清空目前的 HTML
            const oldTiles = gridElement.querySelectorAll('.tile:not(.overlay)');
            oldTiles.forEach(t => t.remove());

            tiles.forEach((num, index) => {
                const tile = document.createElement('div');
                tile.classList.add('tile');
                
                if (num === 0) {
                    tile.classList.add('empty');
                    tile.innerText = "";
                } else {
                    tile.innerText = num;
                    tile.setAttribute('data-val', num);
                    // 點擊事件
                    tile.addEventListener('click', () => handleMove(index));
                    tile.addEventListener('touchstart', (e) => {
                        e.preventDefault(); // 防止雙擊縮放
                        handleMove(index);
                    }, {passive: false});
                }
                
                // 為了避免遮住 overlay，插入在 overlay 之前
                gridElement.insertBefore(tile, overlay);
            });
        }

        // 洗牌邏輯：模擬隨機移動
        function shuffleTiles(steps) {
            for (let i = 0; i < steps; i++) {
                const neighbors = getNeighbors(emptyIndex);
                const randomNeighbor = neighbors[Math.floor(Math.random() * neighbors.length)];
                swap(emptyIndex, randomNeighbor);
                emptyIndex = randomNeighbor;
            }
        }

        // 取得某位置周圍的鄰居索引
        function getNeighbors(index) {
            const neighbors = [];
            const row = Math.floor(index / 4);
            const col = index % 4;

            if (row > 0) neighbors.push(index - 4); // 上
            if (row < 3) neighbors.push(index + 4); // 下
            if (col > 0) neighbors.push(index - 1); // 左
            if (col < 3) neighbors.push(index + 1); // 右

            return neighbors;
        }

        // 處理玩家點擊移動
        function handleMove(index) {
            if (!isGameActive) return;

            // 檢查是否相鄰
            const row = Math.floor(index / 4);
            const col = index % 4;
            const emptyRow = Math.floor(emptyIndex / 4);
            const emptyCol = emptyIndex % 4;

            const isAdjacent = (Math.abs(row - emptyRow) + Math.abs(col - emptyCol)) === 1;

            if (isAdjacent) {
                swap(index, emptyIndex);
                emptyIndex = index;
                moves++;
                moveDisplay.innerText = moves;
                render();
                checkWin();
            }
        }

        // 交換陣列中的兩個元素
        function swap(i, j) {
            [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
        }

        // 檢查是否勝利
        function checkWin() {
            // 檢查是否為 1, 2, 3... 15, 0
            const isWin = tiles.every((val, index) => {
                if (index === 15) return val === 0;
                return val === index + 1;
            });

            if (isWin) {
                isGameActive = false;
                clearInterval(timerInterval);
                overlay.classList.add('show');
            }
        }

        // 計時器
        function startTimer() {
            timerInterval = setInterval(() => {
                timer++;
                timeDisplay.innerText = timer;
            }, 1000);
        }

        // 啟動遊戲
        initGame();

    </script>
</body>
</html>